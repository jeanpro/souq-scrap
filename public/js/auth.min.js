function signOut(){Cookies.remove("uid"),firebase.auth().signOut().then(function(){window.location.pathname="/"},function(e){var a=e.message;console.log(e),alertModal("danger",a),hideLoading()})}function validateURL(e){return e.indexOf("uae.souq.com")!=-1||"Please check if the link is the one from souq: 'http://uae.souq.com...'"}function progressBarAnimate(e,a){var o="";o+='<div class="progress">',o+='  <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 0%">',o+="  </div>",o+="</div>",$(e).prepend(o);var r=$(e+" .progress").width();$(e+" .progress").parent().prepend("<div class='prepend'>Please wait...</div>");var t=$(e+" .progress-bar"),d=r/15,n=setInterval(function(){t.width()<r?t.width(t.width()+d):$(e+" .progress-bar").addClass("progress-bar-striped active")},300+Math.floor(100*Math.random()+1));return n}function timestamp2dateObj(e){var a=e.slice(0,-2).split("/"),o=new Date(parseInt(a[2]),parseInt(a[1])-1,parseInt(a[0])),r={day:parseInt(a[0]),month:parseInt(a[1]),year:parseInt(a[2]),hour:parseInt(e.slice(-2).replace("_","")),date:o,weekDay:weekDay(o.getDay())};return r}function generateGraph(e,a,o){return new Promise(function(a,r){var t=$(o).find(".ct-chart");$(t).html("");var d=$(t).attr("id");$.ajax({method:"POST",url:"/logs",data:{pid:e},success:function(e){if(e.success){var o=[],r=[],t=[];e.stamps.forEach(function(e,a){var d=timestamp2dateObj(e.timestamp);t.length>0?containsObject({day:d.day,month:d.month,year:d.year},t)||(r.push(e.price),o.push(d.day+"/"+d.month+"<br>("+e.price+")"),t.push({day:d.day,month:d.month,year:d.year})):(r.push(e.price),o.push(d.day+"/"+d.month+"<br>("+e.price+")"),t.push({day:d.day,month:d.month,year:d.year}))});var n=new Chartist.Line("#"+d,{labels:o,series:[r]},{low:0,showArea:!0});a(n)}else console.log(e.error),a(!1)},error:function(e){console.log(e),a(!1)}})})}function containsObject(e,a){for(var o=0;o<a.length;o++)if(JSON.stringify(a[o])===JSON.stringify(e))return!0;return!1}function weekDay(e){if(e>=7)return!1;var a=[],o="none"===$("#isSmartphone").css("display")?"sm":"md";switch(o){case"lg":a=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];break;case"md":a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];break;case"sm":a=["S","M","T","W","T","F","S"];break;default:a=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}return e===-1?a:void 0}$(document).ready(function(){$(".addonModal").on("shown.bs.modal",function(){$("#links-collapse").collapse("hide")});var e="";e+='<i><p>No products to show. <a href="#" data-toggle="modal" data-target="#addModal">Click here</a> and start monitoring prices on <a target="_blank" href="http://www.souq.com/" >Souq.com</a></p></i>';var a=Cookies.get("uid");$.ajax({method:"GET",url:"/track",data:{uid:a},success:function(a){a.success?($("#products").html(a.html),$(".graph-open").on("click",function(e){var a=$(this).data("id"),o=timestamp2dateObj($(this).data("original")),r=generateGraph(a,o,"#graphModal");r.then(function(e){e.on("draw",function(e){"line"!==e.type&&"area"!==e.type||e.element.animate({d:{begin:2e3*e.index,dur:2e3,from:e.path.clone().scale(1,0).translate(0,e.chartRect.height()).stringify(),to:e.path.clone().stringify(),easing:Chartist.Svg.Easing.easeOutQuint}})}),e.update()}).catch(function(e){setTimeout(function(){$("#graphModal").modal("hide"),alertModal("danger","Could not open graph.","Error!")},200)})}),$("#removeModal").on("hidden.bs.modal",function(e){resetModal("#removeModal")}),$("#removeModal").on("show.bs.modal",function(e){$("#itemToRemoveImage").attr("src",$(this).data("src")),$("#itemToRemoveImage").closest("a").attr("href",$(this).data("url"))}),$(".btn-remove-track").on("click",function(e){var a=$(this).data("id"),o=$(this).closest("a").attr("href"),r=$(this).closest("img").attr("src");$("#removeModal").data("pid",a),$("#removeModal").data("src",r),$("#removeModal").data("url",o),$("#removeModal").modal("show")}),$("#removeTrack").on("click",function(e){e.preventDefault(),loading();var a=setTimeout(function(){hideLoading()},5e3),o=$("#removeModal").data("pid");$.ajax({method:"GET",url:"/remove",data:{pid:o,uid:firebase.auth().currentUser.uid},success:function(e){clearTimeout(a),hideLoading(),1==e.success?(alertSend("Item removed successfully","#removeModal .modal-content .modal-body .container-fluid","success"),setTimeout(function(){location.reload()},2e3)):(alertSend("Not able to access DB. Try again later...","#removeModal .modal-content .modal-body .container-fluid","danger"),console.log(e.error))},error:function(e){console.log(e),alertSend("Error during request. Check console for more information.","#removeModal .modal-content .modal-body .container-fluid","danger")}})})):$("#products").html(e)},error:function(e){console.log(e),alertModal("alert-danger","Error during request...","Error")}}),$("#addTrack").on("click",function(e){e.preventDefault();var a=JSON.parse(JSON.stringify($("#addproduct").val())),o=validateURL(a);if(a)if(1!=o)alertSend(o,"#addModal .modal-body","danger","Invalid URL!"),$("#addproduct").closest(".form-group").addClass("has-error");else{progressBarAnimate("#addModal .modal-body",10),loading();var r=setTimeout(function(){hideLoading()},2e4);$.ajax({url:"/add",method:"POST",data:{url:a,uid:firebase.auth().currentUser.uid},success:function(e,a,o){$("#addModal .modal-body .progress-bar").css("width","100%"),$("#addModal .modal-body .progress").remove(),$("#addModal .modal-body .prepend").remove(),e.success?(resetModal("#addModal"),alertSend("You have "+e.remaining+" tracks remaining.","#addModal .modal-body","success","Product saved!"),$("#addproduct").closest(".form-group").addClass("has-success"),setTimeout(function(){location.reload()},2e3)):(alertSend(e.error.message,"#addModal .modal-body","danger","Error!"),console.log(e.error)),clearTimeout(r),hideLoading()},error:function(e,a,o){alertSend("Error while processing request. Please, check again later.","#addModal .modal-body","danger",o),console.log(o),clearTimeout(r),hideLoading()}})}else alertSend("Empty URL. Please, check.","#addModal .modal-body"),$("#addproduct").closest(".form-group").addClass("has-error")}),$("#addModal").on("hidden.bs.modal",function(e){resetModal("#addModal")}),$(".signoutBtn").on("click",function(e){ga("send","event","click","btn","SignOut"),loading(),setTimeout(function(){hideLoading()},5e3),signOut()}),hideLoading()});